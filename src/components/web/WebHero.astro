---
import { Image } from 'astro:assets';
import { getCollection } from 'astro:content';

const allProjects = await getCollection('projetos');
// Explicit order to match design aesthetics
const ORDER = ['pedecafe', 'neon-flux', 'fintech'];

const projects = ORDER.map((slug, idx) => {
    const entry = allProjects.find(p => p.slug === slug);
    if (!entry) return null;

    return {
        href: `/projetos/${entry.slug}`,
        slug: entry.slug,
        image: entry.data.coverImage,
        alt: `${entry.data.title} - ${entry.data.description}`,
        tag: entry.data.category,
        title: entry.data.title,
        stack: entry.data.techStack.join(' + '),
        delay: idx === 1 ? 'delay-100' : idx === 2 ? 'delay-200' : '',
        extraClasses: entry.slug === 'fintech' ? 'grayscale brightness-50' : ''
    };
}).filter(p => p !== null);
---

<div class="relative w-full bg-neutral-100 py-20 md:py-40 px-0 md:px-6 overflow-hidden text-black">
    {/* Background Grid */}
    <div class="absolute inset-0 z-0 opacity-5 pointer-events-none" style="background-image: linear-gradient(#000 1px, transparent 1px), linear-gradient(90deg, #000 1px, transparent 1px); background-size: 20px 20px;"></div>
    
    <div class="max-w-7xl mx-auto relative z-10 md:pl-8">
        
        {/* MOBILE LAYOUT (Carousel) */}
        <div class="flex md:hidden overflow-x-auto snap-x snap-mandatory gap-4 px-4 scrollbar-hide pb-8">
            {projects.map((project) => (
                <a
                    href={project.href}
                    data-project-title={project.title}
                    data-project-tag={project.tag}
                    data-astro-prefetch
                    class={`group shrink-0 w-[85vw] max-w-[85vw] snap-center flex flex-col border border-black bg-white shadow-[4px_4px_0px_0px_rgba(0,0,0,1)] transition-all duration-200 project-link overflow-hidden`}
                >
                    {/* Compact Window Header */}
                    <div class="h-[16px] border-b border-black flex items-center px-1.5 gap-1 bg-neutral-100">
                        <div class="w-1.5 h-1.5 rounded-full border border-black bg-white"></div>
                        <div class="w-1.5 h-1.5 rounded-full border border-black bg-white"></div>
                        <div class="w-1.5 h-1.5 rounded-full border border-black bg-white"></div>
                        <span class="ml-auto font-mono text-[8px] uppercase opacity-70 truncate max-w-[60px]" aria-hidden="true">
                            {project.slug}.tsx
                        </span>
                    </div>

                    {/* Image */}
                    <div class="relative aspect-square overflow-hidden border-b border-black bg-neutral-200">
                        <Image
                            src={project.image}
                            alt={project.alt}
                            class={`w-full h-full object-cover object-center grayscale ${project.extraClasses || ''}`}
                            loading="lazy"
                            transition:name={`project-image-${project.slug}`}
                        />
                    </div>

                    {/* Info */}
                    <div class="p-4 flex flex-col gap-2">
                        <div class="flex justify-between items-start">
                            <h2 class="text-lg font-bold uppercase tracking-tight leading-none">
                                {project.title}
                            </h2>
                            <span class="text-[8px] font-mono border border-black px-1 rounded-sm uppercase bg-white">
                                {project.tag}
                            </span>
                        </div>
                        <div class="font-mono text-[10px] text-black/70 pt-2 border-t border-black/10 mt-1 whitespace-nowrap overflow-hidden text-ellipsis" aria-hidden="true">
                            {`[ STACK: ${project.stack} // PERF: 100% ]`}
                        </div>
                    </div>
                </a>
            ))}
        </div>

        {/* Mobile Indicators */}
        <div class="flex md:hidden justify-center items-center gap-2 mt-4 mb-4 font-mono text-[10px] text-black/40">
            <span>01</span>
            <div class="flex gap-1">
                 {projects.map(() => <div class="w-1 h-1 bg-black rounded-full"></div>)}
            </div>
            <span>0{projects.length}</span>
        </div>

        {/* DESKTOP LAYOUT (Grid) */}
        <div class="hidden md:grid md:grid-cols-3 gap-8 px-0">
            {projects.map((project) => (
                <a
                    href={project.href}
                    data-project-title={project.title}
                    data-project-tag={project.tag}
                    data-astro-prefetch
                    class={`group flex flex-col border-2 border-black bg-white shadow-[4px_4px_0px_0px_rgba(0,0,0,1)] hover:translate-y-[-2px] hover:shadow-[6px_6px_0px_0px_rgba(0,0,0,1)] transition-all duration-200 project-link reveal-up ${project.delay} overflow-hidden`}
                >
                    {/* Full Window Header */}
                    <div class="h-8 border-b-2 border-black flex items-center px-3 gap-2 bg-neutral-100">
                        <div class="w-2.5 h-2.5 rounded-full border border-black bg-white"></div>
                        <div class="w-2.5 h-2.5 rounded-full border border-black bg-white"></div>
                        <div class="w-2.5 h-2.5 rounded-full border border-black bg-white"></div>
                        <span class="ml-auto font-mono text-[10px] uppercase opacity-70" aria-hidden="true">
                            {project.slug}.tsx
                        </span>
                    </div>

                    {/* Image */}
                    <div class="relative aspect-square overflow-hidden border-b-2 border-black bg-neutral-200 group-hover:contrast-[1.1] transition-all">
                        <Image
                            src={project.image}
                            alt={project.alt}
                            class={`w-full h-full object-cover object-center grayscale group-hover:grayscale-0 transition-all duration-500 ${project.extraClasses || ''}`}
                            loading="lazy"
                            transition:name={`project-image-${project.slug}`}
                        />
                    </div>

                    {/* Info */}
                    <div class="p-4 flex flex-col gap-2">
                        <div class="flex justify-between items-start">
                            <h2 class="text-xl font-bold uppercase tracking-tight leading-none">
                                {project.title}
                            </h2>
                            <span class="text-[10px] font-mono border border-black px-1 py-0.5 rounded-sm uppercase">
                                {project.tag}
                            </span>
                        </div>
                        <div class="font-mono text-[10px] text-black/70 pt-2 border-t border-black/10 mt-2" aria-hidden="true">
                            {`[ STACK: ${project.stack} // PERF: 100% ]`}
                        </div>
                    </div>
                </a>
            ))}
        </div>

    </div>
</div>

<style>
    .scrollbar-hide::-webkit-scrollbar {
        display: none;
    }
    .scrollbar-hide {
        -ms-overflow-style: none; /* IE and Edge */
        scrollbar-width: none; /* Firefox */
    }
</style>

<script>
    import { captureEvent } from '../../lib/analytics';

    document.querySelectorAll('.project-link').forEach(link => {
        link.addEventListener('click', (e) => {
            const el = e.currentTarget as HTMLAnchorElement;
            const title = el.getAttribute('data-project-title');
            const tag = el.getAttribute('data-project-tag');
            
            captureEvent('project_viewed', {
                project_title: title,
                project_tag: tag,
                source: 'web_lp'
            });
        });
    });
</script>
