---
const GTM_ID = 'GTM-N5PSJC3D';
const PIXEL_ID = import.meta.env.NEXT_PUBLIC_META_PIXEL_ID;
const POSTHOG_KEY = import.meta.env.NEXT_PUBLIC_POSTHOG_KEY;
const POSTHOG_HOST = import.meta.env.NEXT_PUBLIC_POSTHOG_HOST || 'https://us.i.posthog.com';
const GA_ID = import.meta.env.PUBLIC_GA_ID || import.meta.env.NEXT_PUBLIC_GA_ID;
---

<!-- Google Analytics -->
{import.meta.env.PROD && GA_ID && (
  <>
    <script type="text/partytown" src={`https://www.googletagmanager.com/gtag/js?id=${GA_ID}`}></script>
    <script type="text/partytown" define:vars={{ GA_ID }}>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());
      
      document.addEventListener('astro:page-load', () => {
          gtag('config', GA_ID, {
              page_path: window.location.pathname,
          });
      });
    </script>
  </>
)}

<!-- Google Tag Manager (Partytown) -->
<script type="text/partytown" define:vars={{ GTM_ID }}>
    (function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
    new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
    j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
    'https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
    })(window,document,'script','dataLayer', GTM_ID);
</script>

<!-- Meta Pixel -->
{PIXEL_ID && (
<script type="text/partytown" define:vars={{ PIXEL_ID }}>
    !function(f,b,e,v,n,t,s)
    {if(f.fbq)return;n=f.fbq=function(){n.callMethod?
    n.callMethod.apply(n,arguments):n.queue.push(arguments)};
    if(!f._fbq)f._fbq=n;n.push=n;n.loaded=!0;n.version='2.0';
    n.queue=[];t=b.createElement(e);t.async=!0;
    t.src=v;s=b.getElementsByTagName(e)[0];
    s.parentNode.insertBefore(t,s)}(window, document,'script',
    'https://connect.facebook.net/en_US/fbevents.js');
    fbq('init', PIXEL_ID);
    
    document.addEventListener('astro:page-load', () => {
        fbq('track', 'PageView');
    });
</script>
<noscript>
    <img height="1" width="1" style="display:none"
    src={`https://www.facebook.com/tr?id=${PIXEL_ID}&ev=PageView&noscript=1`}
    />
</noscript>
)}

<!-- PostHog -->
{POSTHOG_KEY && (
<script type="text/partytown" define:vars={{ POSTHOG_KEY, POSTHOG_HOST }}>
    !function(t,e){var o,n,p,r;e.__SV||(window.posthog=e,e._i=[],e.init=function(i,s,a){function g(t,e){var o=e.split(".");2==o.length&&(t=t[o[0]],e=o[1]),t[e]=function(){t.push([e].concat(Array.prototype.slice.call(arguments,0)))}}(p=t.createElement("script")).type="text/javascript",p.async=!0,p.src=s.api_host+"/static/array.js",(r=t.getElementsByTagName("script")[0]).parentNode.insertBefore(p,r);var u=e;for(void 0!==a?u=e[a]=[]:a="posthog",u.people=u.people||[],u.toString=function(t){var e="posthog";return"posthog"!==a&&(e+="."+a),t||(e+=" (stub)"),e},u.people.toString=function(){return u.toString(1)+".people (stub)"},o="capture identify alias people.set people.set_once set_config register register_once unregister opt_out_capturing has_opted_out_capturing opt_in_capturing reset isFeatureEnabled onFeatureFlags getFeatureFlag getFeatureFlagPayload reloadFeatureFlags group updateEarlyAccessFeatureEnrollment getEarlyAccessFeatures getActiveMatchingSurveys getSurveys onSessionId".split(" "),n=0;n<o.length;n++)g(u,o[n]);e._i.push([i,s,a])},e.__SV=1)}(document,window.posthog||[]);
    
    posthog.init(POSTHOG_KEY, {
        api_host: POSTHOG_HOST,
        capture_pageview: false, // Manually controlled for view transitions
        persistence: 'localStorage'
    });

    document.addEventListener('astro:page-load', () => {
        posthog.capture('$pageview');
    });
</script>
)}
